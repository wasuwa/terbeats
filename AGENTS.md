# 共通
日本語かつ丁寧に回答してください。

# Repository Guidelines

## プロジェクト構成 / モジュール
- `main.go`: `tview`/`tcell`によるTUIエントリーポイント。レーンと落下ノーツの描画を担当。
- `go.mod`, `go.sum`: Go Modules 設定（Go 1.23）。
- テストは同一ディレクトリの `*_test.go` に配置。規模拡大時は `cmd/terbeats/`、`internal/ui`、`internal/game` などの分割を検討。

## ビルド・実行・テスト
- 実行: `go run ./cmd/game/main.go` — ローカルでTUIを起動。
- ビルド: `go build -o bin/terbeats .` — 実行バイナリを生成。
- テスト: `go test ./...` — すべてのパッケージをテスト。
- カバレッジ: `go test -cover ./...` — 簡易カバレッジを表示。
- 整形/静的解析: `gofmt -s -w .`、`go vet ./...`、依存整理は `go mod tidy`。

## コーディング規約・命名
- フォーマット: `gofmt` 準拠（基本はタブ）。`goimports` 使用可。
- 命名: パッケージは短い小文字、公開識別子は `CamelCase`、ファイルは `snake_case.go`。
- 設計: 小さな責務のパッケージを好み、グローバル状態を避け、依存は明示的に注入。

## テスト方針
- フレームワーク: 標準の `testing`。表駆動テストを推奨（`*_test.go`）。
- 対象: 純粋関数とUIロジックを分離したインターフェース単位で検証。
- コマンド: 競合検出は `go test -race ./...` を適宜使用。

## コミット / プルリクエスト
- コミット: Conventional Commits を推奨（例: `feat(ui): adjust lane spacing`, `fix(render): prevent flicker`）。
- PR: 目的・要約・UI変更のスクリーンショット/GIF・関連Issueのリンクを含める。1トピック1PRを原則とし、挙動変更時は `README.md` も更新。
- 送信前チェック: `gofmt`/`go vet`/`go mod tidy` を実行。

## コミュニケーションと言語
- このリポジトリでは、日本語でのやり取りを基本とします（Issue/PR/レビュー/回答）。英語の投稿も歓迎しますが、メンテナの返答は日本語が優先されます。

## セキュリティ / 設定Tips
- 端末: `tcell` の色再現のため `TERM=xterm-256color` など True Color 対応を推奨。
- 機密: 秘密情報はリポジトリに含めない。設定が必要な場合は環境変数を利用。
- 開発環境: Go は `go.mod` に合わせて 1.23 以上を使用。

---

## エージェント運用方針（AGENTS Best Practices）

このリポジトリでAIエージェント（例: Codex CLI）を活用する際の実践的ガイドです。最小差分・安全性・再現性を重視してください。

### トーンとスタイル
- 丁寧・簡潔: 余計な前置きは避け、要点を短く明確に。
- 日本語優先: やり取り・説明・ドキュメントは日本語で統一。

### 進め方（小さく計画→実装→検証）
- 計画: `update_plan` で3〜6個の短いステップを提示。必ず1件だけ `in_progress`。
- 予告: コマンド実行や大きめ変更の直前に1〜2文で意図を共有。
- 実装: `apply_patch` による最小差分。無関係な整形や改名は避ける。
- 検証: 影響範囲の `go test`, `go vet`, `gofmt` を優先的に実施。

### Codex CLIでのツール使用
- `shell`: 検索は `rg` を優先。ファイル閲覧は1回あたり最大200行を目安。
- `apply_patch`: すべての編集はこれ経由。相対パスのみ。小さなコミットに分割。
- サンドボックス/承認: 書き込み・ネットワークが制限される場合は、理由を1行で明示し承認を得る。
- ログ: 重要な意思決定は短い日本語メモを残し、追跡可能に。

### Go/terbeats固有の実装ガイド
- 構成: 現状は `main.go` 中心。規模化時は `cmd/terbeats/`、`internal/ui`、`internal/game` に分割。
- レンダリング/イベント:
  - `tview.Application` の更新は `QueueUpdate(…)/QueueUpdateDraw(…)` を用い、メインループをブロックしない。
  - フレーム駆動は `time.Ticker` 等でレート制御（例: 60Hz）。ビジーループを避ける。
  - 入力は `SetInputCapture` で一元化し、キー設定は定数/表で管理。
- モデル分離:
  - ゲームモデル（Lane/Note/判定/譜面）はUIと分離し、純粋ロジックとしてテスト可能に。
  - 時間は単位を明示（ms など）。描画座標と論理座標は明確に変換。
- エラー/ログ:
  - ライブラリエラーは `fmt.Errorf("… %w", err)` でラップ。致命/非致命を分離。
  - ログは標準 `log` を使用し、フレーム内多量出力は避ける。
- パフォーマンス:
  - 描画ループ内の割り当て削減（バッファ/Styleの再利用、キャッシュ化）。
  - 可能なら差分描画（dirty領域）や計算の先読みを検討。
- 端末互換:
  - `TERM=xterm-256color` を推奨し、色フォールバックを設ける。
  - 端末差異によるキーコードの揺れを考慮（特に修飾キー）。

### コミット/PR 補足
- Conventional Commits の推奨スコープ: `ui`, `game`, `input`, `render`, `timing`, `docs`, `build`, `ci`, `deps`。
- スクリーンショット/GIF: UI差分があるPRは簡易プレビューを添付。
- 変更の最小化: フォーマットだけの差分や関係ないリネームは別PRに分離。

### 作業チェックリスト（エージェント用）
- 実装前: 影響範囲・代替案・デグレ可能性を短く共有。
- 実装中: 小さくパッチ。関連箇所だけ整形。不要な最適化は避ける。
- 実装後: `gofmt -s -w .`、`go vet ./...`、`go mod tidy`、`go test -race ./...` を順に。
- ドキュメント: 仕様/挙動変更時は `README.md` と本 `AGENTS.md` を更新。

### よくある落とし穴
- メインスレッドでの長時間 `Sleep` により入力が固まる。
- `tview` UI状態を複数goroutineから直接触りデータ競合が発生。
- 端末依存のキーコード差でショートカットが効かない。
- フレーム毎に新規 `Style`/`[]rune` を生成してGCが増大。

### 例: 小さなPRの進め方
1) 目的とゴールを2〜3行で共有。
2) `update_plan` で作業手順（3〜5ステップ）。
3) `apply_patch` で変更 → `go test -race` で確認。
4) スクショ/GIFを添付し、想定外挙動/残課題を明記。
